# Crystal Guardians ゲーム仕様書

## 1. ゲーム概要

### 1.1 基本情報
- **ゲーム名**: Crystal Guardians
- **ジャンル**: タワーディフェンスゲーム
- **プラットフォーム**: Webブラウザ（HTML5/JavaScript）
- **開発言語**: JavaScript, HTML5, CSS3

### 1.2 ゲームコンセプト
Artisan TD風のグリッドベースマップシステムを持つタワーディフェンスゲーム。プレイヤーは様々なキャラクターを配置して、クリスタルを守り抜く。

## 2. システム仕様

### 2.1 グリッドシステム
- **グリッドサイズ**: 11×8 (GRID_WIDTH=11, GRID_HEIGHT=8)
- **パネルサイズ**: 64×64px (PANEL_SIZE=64)
- **総画面サイズ**: 704×512px

### 2.2 パネルタイプ
```javascript
PANEL_TYPES = {
    ROAD: 'road',           // 道路パネル：敵が通過、配置不可
    BUILDABLE: 'buildable', // 配置可能パネル：タワー配置可能
    BLOCKED: 'blocked',     // 配置不可パネル：岩や水
    START: 'start',         // スタートパネル
    GOAL: 'goal',          // ゴールパネル
    ROCK: 'rock',          // 岩：配置不可、敵進行不可、射線ブロック
    WATER: 'water'         // 池：配置不可、地上敵進行不可、空中敵通過可能
}
```

### 2.3 マップ配置ルール
1. **スタート地点**: マップの外周（端）のみに配置可能
2. **ゴール地点**: マップの外周（端）のみに配置可能
3. **道路タイル**: 行動ルートのみに配置
4. **行動ルート**: スタートからゴールまでの連続した道

## 3. マップ仕様

### 3.1 マップ一覧
1. **森の小道** (初級)
   - スタート: 左端 (0,3)
   - ゴール: 右端 (10,3)
   - 特徴: 直線ルート

2. **曲がりくねった峡谷** (中級)
   - スタート: 右上端 (10,0)
   - ゴール: 左下端 (0,7)
   - 特徴: S字カーブルート

3. **分岐する遺跡** (上級)
   - スタート: 上端 (0,0) と下端 (0,7)
   - ゴール: 右端 (10,0)
   - 特徴: 2つのスタートから合流するルート

### 3.2 Wave構成
- **各マップ**: 3Wave構成
- **Wave間隔**: 4秒
- **敵出現**: 複数スタート地点からランダム出現

## 4. キャラクター仕様

### 4.1 配置可能キャラクター
1. **ソードマン** (近接攻撃)
   - コスト: 50G
   - 攻撃力: 30
   - 射程: 1タイル
   - 攻撃速度: 1.5秒

2. **アーチャー** (遠距離攻撃)
   - コスト: 80G
   - 攻撃力: 25
   - 射程: 3タイル
   - 攻撃速度: 2.0秒

3. **メイジ** (魔法攻撃)
   - コスト: 120G
   - 攻撃力: 40
   - 射程: 2タイル
   - 攻撃速度: 3.0秒

### 4.2 配置ルール
- **配置可能場所**: BUILDABLE タイプのパネルのみ
- **配置不可場所**: 道路、岩、水、スタート、ゴール
- **重複配置**: 不可（1パネル1キャラクター）

## 5. 敵仕様

### 5.1 敵タイプ
1. **ゴブリン**
   - HP: 50
   - 速度: 1.0
   - 報酬: 10G
   - タイプ: 地上

2. **オーク**
   - HP: 100
   - 速度: 0.8
   - 報酬: 20G
   - タイプ: 地上

3. **装甲ゴブリン**
   - HP: 80
   - 速度: 0.9
   - 報酬: 15G
   - タイプ: 地上

4. **オーク族長**
   - HP: 200
   - 速度: 0.6
   - 報酬: 40G
   - タイプ: 地上

5. **コウモリ**
   - HP: 30
   - 速度: 1.5
   - 報酬: 15G
   - タイプ: 空中

### 5.2 移動ルール
- **地上ユニット**: 道路タイルのみ通過可能、複数スタート地点からランダム出現
- **空中ユニット**: 直線ルート、岩による射線ブロックあり

## 6. ゲームシステム

### 6.1 リソース管理
- **初期ゴールド**: 100G
- **クリスタルHP**: 20（敵20体まで到達可能）
- **ゴールド獲得**: 敵撃破時、Wave完了時

### 6.2 Wave管理システム
- **Wave完了条件**: 全ての敵がスポーンされ、かつ残り敵が0体になった時点で即座に完了
- **敵削除処理**: WaveManagerが一元管理、重複削除を防止
- **敵撃破処理**: キャラクターの攻撃→敵HP減少→WaveManagerで削除→コールバック呼び出し
- **敵到達処理**: 敵のhasReachedGoal()判定→WaveManagerで削除→コールバック呼び出し
- **Wave完了判定**: 遅延なしで即座に実行
- **敵管理**: WaveManagerが敵の生成・削除・状態管理を一元化
- **重複処理防止**: hasReachedGoalFlagによる重複処理防止機能

### 6.3 天候システム
- **晴天**: 通常状態
- **雨**: 移動速度-10%、攻撃力+5%
- **雪**: 移動速度-20%、攻撃力+10%
- **嵐**: 移動速度-15%、攻撃力+15%

### 6.4 難易度システム
- **マップ別難易度**: 初級→中級→上級
- **天候連動**: 天候効果が難易度に影響
- **報酬倍率**: 難易度に応じて調整

## 7. UI仕様

### 7.1 インフォメーション表示条件
- **マップ選択後**: 0.5秒後に自動表示
- **Wave勝利後**: 0.5秒後に自動表示
- **Wave開始時**: 表示しない（修正済み）

### 7.2 ミニマップ機能
- **地上ルート表示**: 複数スタート地点からのアニメーション付きルート
- **空中ルート表示**: ベジェ曲線による滑らかな空中ルート
- **リアルタイム更新**: requestAnimationFrameによる滑らかなアニメーション

### 7.3 UI要素
- **トップバー**: ゴールド、Wave情報、クリスタルHP
- **キャラクター選択パネル**: ドラッグ&ドロップ配置
- **天候・時間帯パネル**: 現在の状況と予報
- **難易度パネル**: 現在の難易度情報

## 8. 技術仕様

### 8.1 ファイル構成
```
crystal-guardians/
├── index.html              # メインHTML
├── css/
│   └── style.css          # スタイルシート
├── js/
│   ├── game.js            # メインゲームロジック
│   ├── grid.js            # グリッドシステム
│   ├── stages.js          # マップ・Wave管理
│   ├── enemies.js         # 敵システム
│   ├── characters.js      # キャラクターシステム
│   ├── minimap.js         # ミニマップ機能
│   ├── weather.js         # 天候システム
│   └── difficulty.js      # 難易度システム
└── SPECIFICATION.md       # 本仕様書
```

### 8.2 主要クラス
- **Game**: メインゲーム制御
- **GridSystem**: グリッド管理
- **GridWaveManager**: Wave・マップ管理
- **Enemy**: 敵オブジェクト
- **Character**: キャラクターオブジェクト
- **MiniMapRenderer**: ミニマップ描画
- **WeatherSystem**: 天候管理
- **DifficultySystem**: 難易度管理

### 8.3 データフロー
1. **マップ選択** → GridSystem.loadMap() → マップデータ読み込み
2. **グリッド初期化** → パネルタイプ設定 → 道路タイル配置
3. **行動ルート生成** → 道路タイルベースのパスファインディング
4. **敵出現** → 複数スタート地点からランダム選択 → パス設定
5. **キャラクター配置** → BUILDABLE パネルのみ → 攻撃処理

## 9. パフォーマンス仕様

### 9.1 最適化項目
- **アニメーション**: requestAnimationFrame使用
- **敵管理**: 配列の安全な削除処理
- **UI同期**: 必要時のみ更新
- **メモリ管理**: 不要オブジェクトの適切な削除

### 9.2 対応ブラウザ
- **Chrome**: 最新版
- **Firefox**: 最新版
- **Safari**: 最新版
- **Edge**: 最新版

## 10. 今後の拡張予定

### 10.1 機能追加
- [ ] 追加マップ
- [ ] 新キャラクタータイプ
- [ ] スキルシステム
- [ ] セーブ機能

### 10.2 改善項目
- [ ] モバイル対応
- [ ] 音響効果
- [ ] パーティクルエフェクト
- [ ] ランキングシステム

---

**最終更新**: 2024年12月
**バージョン**: 1.0.0 